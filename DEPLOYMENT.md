# Deployment Configuration

## Pre-deployment Checklist

### 1. Environment Variables
Ensure these are set in your Render dashboard:

**Required:**
- `DATABASE_URL` (auto-provided by Render PostgreSQL)
- `SESSION_SECRET` (auto-generated by Render)
- `NODE_ENV=production`

**Optional but Recommended:**
- `CLOUDINARY_CLOUD_NAME`
- `CLOUDINARY_API_KEY` 
- `CLOUDINARY_API_SECRET`
- `TOGETHER_API_KEY`
- `GEMINI_API_KEY`
- `SENDGRID_API_KEY`
- `GOOGLE_VISION_API_KEY`

### 2. Database Setup
The database will be automatically created and connected via `DATABASE_URL`.
Migrations will run automatically via the `postinstall` script.

### 3. Build Configuration
- Frontend builds to `./client/dist`
- Backend builds to `./dist`
- Static files served from frontend build

### 4. Health Check
- Health endpoint: `/health`
- Ping endpoint: `/ping`
- Used by Render for service monitoring

### 5. Security Configuration
- CORS configured for Render domains
- CSP allows necessary external resources
- Rate limiting configured for production

## Deployment Steps

1. **Push to GitHub:**
   ```bash
   git add .
   git commit -m "Configure for Render deployment"
   git push origin main
   ```

2. **Deploy to Render:**
   - Go to Render.com
   - Click "New" â†’ "Blueprint"
   - Connect your GitHub repo
   - Select this repository
   - Render will read `render.yaml` and create all services

3. **Set Environment Variables:**
   - Go to each service in Render dashboard
   - Add required environment variables
   - Deploy will automatically restart

4. **Verify Deployment:**
   - Check health endpoint: `https://your-api.onrender.com/health`
   - Test frontend: `https://your-frontend.onrender.com`
   - Monitor logs for any issues

## Post-deployment

### Update DNS (if using custom domain)
1. Add your domain to both services in Render
2. Update CORS origins in `security.ts`
3. Update CSP if needed

### Monitor Services
- Use health endpoints for uptime monitoring
- Set up log monitoring in Render dashboard
- Monitor database performance

### Performance Optimization
- Static files are cached for 1 year
- HTML files are not cached (for updates)
- Compression enabled for all responses
- Rate limiting prevents abuse

## Troubleshooting

### Common Issues:

1. **CORS Errors:**
   - Check allowed origins in `security.ts`
   - Verify frontend URL matches CORS config

2. **Database Connection:**
   - Check `DATABASE_URL` environment variable
   - Verify database service is running
   - Check migration logs

3. **Build Failures:**
   - Check build logs in Render dashboard
   - Verify all dependencies are in `package.json`
   - Check TypeScript compilation

4. **API Errors:**
   - Check server logs in Render dashboard
   - Verify environment variables are set
   - Test health endpoint

### Useful Commands:
```bash
# Test local build
npm run build

# Test production mode locally
npm start

# Check health endpoint
curl https://your-api.onrender.com/health

# Test CORS
curl -H "Origin: https://your-frontend.onrender.com" \
     -H "Access-Control-Request-Method: GET" \
     -X OPTIONS https://your-api.onrender.com/api/quizzes
```
